{"ast":null,"code":"\"use strict\";\n/**\n * Copyright 2019 Google Inc. All rights reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.LifecycleWatcher = void 0;\n\nconst assert_js_1 = require(\"./assert.js\");\n\nconst helper_js_1 = require(\"./helper.js\");\n\nconst Errors_js_1 = require(\"./Errors.js\");\n\nconst FrameManager_js_1 = require(\"./FrameManager.js\");\n\nconst NetworkManager_js_1 = require(\"./NetworkManager.js\");\n\nconst Connection_js_1 = require(\"./Connection.js\");\n\nconst puppeteerToProtocolLifecycle = new Map([['load', 'load'], ['domcontentloaded', 'DOMContentLoaded'], ['networkidle0', 'networkIdle'], ['networkidle2', 'networkAlmostIdle']]);\n/**\n * @internal\n */\n\nclass LifecycleWatcher {\n  constructor(frameManager, frame, waitUntil, timeout) {\n    if (Array.isArray(waitUntil)) waitUntil = waitUntil.slice();else if (typeof waitUntil === 'string') waitUntil = [waitUntil];\n    this._expectedLifecycle = waitUntil.map(value => {\n      const protocolEvent = puppeteerToProtocolLifecycle.get(value);\n      (0, assert_js_1.assert)(protocolEvent, 'Unknown value for options.waitUntil: ' + value);\n      return protocolEvent;\n    });\n    this._frameManager = frameManager;\n    this._frame = frame;\n    this._initialLoaderId = frame._loaderId;\n    this._timeout = timeout;\n    this._navigationRequest = null;\n    this._eventListeners = [helper_js_1.helper.addEventListener(frameManager._client, Connection_js_1.CDPSessionEmittedEvents.Disconnected, () => this._terminate(new Error('Navigation failed because browser has disconnected!'))), helper_js_1.helper.addEventListener(this._frameManager, FrameManager_js_1.FrameManagerEmittedEvents.LifecycleEvent, this._checkLifecycleComplete.bind(this)), helper_js_1.helper.addEventListener(this._frameManager, FrameManager_js_1.FrameManagerEmittedEvents.FrameNavigatedWithinDocument, this._navigatedWithinDocument.bind(this)), helper_js_1.helper.addEventListener(this._frameManager, FrameManager_js_1.FrameManagerEmittedEvents.FrameSwapped, this._frameSwapped.bind(this)), helper_js_1.helper.addEventListener(this._frameManager, FrameManager_js_1.FrameManagerEmittedEvents.FrameDetached, this._onFrameDetached.bind(this)), helper_js_1.helper.addEventListener(this._frameManager.networkManager(), NetworkManager_js_1.NetworkManagerEmittedEvents.Request, this._onRequest.bind(this))];\n    this._sameDocumentNavigationPromise = new Promise(fulfill => {\n      this._sameDocumentNavigationCompleteCallback = fulfill;\n    });\n    this._lifecyclePromise = new Promise(fulfill => {\n      this._lifecycleCallback = fulfill;\n    });\n    this._newDocumentNavigationPromise = new Promise(fulfill => {\n      this._newDocumentNavigationCompleteCallback = fulfill;\n    });\n    this._timeoutPromise = this._createTimeoutPromise();\n    this._terminationPromise = new Promise(fulfill => {\n      this._terminationCallback = fulfill;\n    });\n\n    this._checkLifecycleComplete();\n  }\n\n  _onRequest(request) {\n    if (request.frame() !== this._frame || !request.isNavigationRequest()) return;\n    this._navigationRequest = request;\n  }\n\n  _onFrameDetached(frame) {\n    if (this._frame === frame) {\n      this._terminationCallback.call(null, new Error('Navigating frame was detached'));\n\n      return;\n    }\n\n    this._checkLifecycleComplete();\n  }\n\n  async navigationResponse() {\n    // We may need to wait for ExtraInfo events before the request is complete.\n    return this._navigationRequest ? this._navigationRequest.response() : null;\n  }\n\n  _terminate(error) {\n    this._terminationCallback.call(null, error);\n  }\n\n  sameDocumentNavigationPromise() {\n    return this._sameDocumentNavigationPromise;\n  }\n\n  newDocumentNavigationPromise() {\n    return this._newDocumentNavigationPromise;\n  }\n\n  lifecyclePromise() {\n    return this._lifecyclePromise;\n  }\n\n  timeoutOrTerminationPromise() {\n    return Promise.race([this._timeoutPromise, this._terminationPromise]);\n  }\n\n  _createTimeoutPromise() {\n    if (!this._timeout) return new Promise(() => {});\n    const errorMessage = 'Navigation timeout of ' + this._timeout + ' ms exceeded';\n    return new Promise(fulfill => this._maximumTimer = setTimeout(fulfill, this._timeout)).then(() => new Errors_js_1.TimeoutError(errorMessage));\n  }\n\n  _navigatedWithinDocument(frame) {\n    if (frame !== this._frame) return;\n    this._hasSameDocumentNavigation = true;\n\n    this._checkLifecycleComplete();\n  }\n\n  _frameSwapped(frame) {\n    if (frame !== this._frame) return;\n    this._swapped = true;\n\n    this._checkLifecycleComplete();\n  }\n\n  _checkLifecycleComplete() {\n    // We expect navigation to commit.\n    if (!checkLifecycle(this._frame, this._expectedLifecycle)) return;\n\n    this._lifecycleCallback();\n\n    if (this._frame._loaderId === this._initialLoaderId && !this._hasSameDocumentNavigation) {\n      if (this._swapped) {\n        this._swapped = false;\n\n        this._newDocumentNavigationCompleteCallback();\n      }\n\n      return;\n    }\n\n    if (this._hasSameDocumentNavigation) this._sameDocumentNavigationCompleteCallback();\n    if (this._frame._loaderId !== this._initialLoaderId) this._newDocumentNavigationCompleteCallback();\n    /**\n     * @param {!Frame} frame\n     * @param {!Array<string>} expectedLifecycle\n     * @returns {boolean}\n     */\n\n    function checkLifecycle(frame, expectedLifecycle) {\n      for (const event of expectedLifecycle) {\n        if (!frame._lifecycleEvents.has(event)) return false;\n      }\n\n      for (const child of frame.childFrames()) {\n        if (!checkLifecycle(child, expectedLifecycle)) return false;\n      }\n\n      return true;\n    }\n  }\n\n  dispose() {\n    helper_js_1.helper.removeEventListeners(this._eventListeners);\n    clearTimeout(this._maximumTimer);\n  }\n\n}\n\nexports.LifecycleWatcher = LifecycleWatcher;","map":{"version":3,"mappings":"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","names":["puppeteerToProtocolLifecycle","Map","LifecycleWatcher","constructor","frameManager","frame","waitUntil","timeout","Array","isArray","slice","_expectedLifecycle","map","value","protocolEvent","get","_frameManager","_frame","_initialLoaderId","_loaderId","_timeout","_navigationRequest","_eventListeners","helper_js_1","addEventListener","_client","Connection_js_1","Disconnected","_terminate","Error","FrameManager_js_1","LifecycleEvent","_checkLifecycleComplete","bind","FrameNavigatedWithinDocument","_navigatedWithinDocument","FrameSwapped","_frameSwapped","FrameDetached","_onFrameDetached","networkManager","NetworkManager_js_1","Request","_onRequest","_sameDocumentNavigationPromise","Promise","fulfill","_sameDocumentNavigationCompleteCallback","_lifecyclePromise","_lifecycleCallback","_newDocumentNavigationPromise","_newDocumentNavigationCompleteCallback","_timeoutPromise","_createTimeoutPromise","_terminationPromise","_terminationCallback","request","isNavigationRequest","call","navigationResponse","response","error","sameDocumentNavigationPromise","newDocumentNavigationPromise","lifecyclePromise","timeoutOrTerminationPromise","race","errorMessage","_maximumTimer","setTimeout","then","Errors_js_1","_hasSameDocumentNavigation","_swapped","checkLifecycle","expectedLifecycle","event","_lifecycleEvents","has","child","childFrames","dispose","removeEventListeners","clearTimeout","exports"],"sources":["../../../../src/common/LifecycleWatcher.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}